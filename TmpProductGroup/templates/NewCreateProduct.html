{% extends 'ProductAdminPage.html' %}

{% load static %}
{% block content %}
    <script type="text/javascript" src="{% static 'js/jquery.js' %}"></script>
    <script type="text/javascript" src="{% static 'app/js_createNewProduct.js' %}"></script>

     <!-- include libries(jQuery, bootstrap, fontawesome) -->

   <link href="http://netdna.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.css" rel="stylesheet">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
  <script src="http://netdna.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.js"></script>
            <script src="{% static 'js/distpicker.data.js' %}"></script>
        <script src="{% static 'js/distpicker.js' %}"></script>
    <script language="javascript">
       function check(){
            if($('#_productService').is(':checked')){
            } else
            {
                alert("请选择商品服务");
                return false;
            }
            if($('.checkbox_style_tag').is(':checked')){
            } else
            {
                alert("请至少选择一件商品");
                return false;
            }
            var firstLength = 0;
            $('input[name=second_style_1]').each(function(){
            　　 if($(this).val()!='') firstLength++;
            });
            var secondLength = 0;
            $('input[name=second_style_2]').each(function(){
            　　 if($(this).val()!='')secondLength++;
            });
            var thirdLength = 0;
            $('input[name=second_style_3]').each(function(){
            　　 if($(this).val()!='')thirdLength++;
            });
            var dict1 = {};
            var dict2 ={};
            var dict3 = {};
            var temp3, temp2;
            $('.checkbox_style_tag').each(function () {
                if($(this).is(':checked')){
                    var temp = $(this).val().split('::')[0];
                    if (!dict1.hasOwnProperty(temp)){
                        dict1[temp] = true;
                    }
                    temp2 = $(this).val().split('::')[1];
                    if (temp2!= undefined && !dict2.hasOwnProperty(temp2)){
                        dict2[temp2] = true;
                    }
                    temp3 = $(this).val().split('::')[2];
                    if (temp3!= undefined && !dict3.hasOwnProperty(temp3)){
                        dict3[temp3] = true;
                    }
                }
            });
            if(Object.keys(dict1).length < firstLength || (temp2 != undefined && Object.keys(dict2).length < secondLength) || (temp3 != undefined &&Object.keys(dict3).length < thirdLength)){
                alert('每种属性都必须至少选择一样');
                return false;
            }

            return true;
        }
    //确认检查

    // 用于检查输入是否有效
        $(document).on('blur','form :input', function(){
            var $parent = $(this).parent();
            $parent.find(".formtips").remove();

            //验证名称，规格，规格信息
            if( $(this).is('#_productName') || $(this).is('#_dispatchPlace') ){
                if( this.value.length > 20 ){
                    $parent.append('<span class="formtips onError">'+'不得超过20个字符.'+'<\/span>');
                    $(this).focus();
                }
            }
            if( $(this).is('input[name=first_style]')) {
                 if( this.value.length > 4 ){
                    $parent.append('<span class="formtips onError">'+'字数不能超过4个字符.'+'<\/span>');
                    $(this).focus();
                    return;
                 }
                 var o={};
                $(this).closest('#id_createTag').find('input[name=first_style]').each(function () {
                    if($(this).val() != ''){
                        if(!(o[$(this).val()])){
                            o[$(this).val()] = true;
                        }else{
                            $parent.append('<span class="formtips onError">'+'输入标签不得重复.'+'<\/span>');
                            $(this).focus();
                            $(this).val('');
                            return false;
                        }
                    }
                });
            }
            if( $(this).is('.second_style')){
                if( this.value.length > 10 ){
                    $parent.append('<span class="formtips onError">'+'不得超过10个字符.'+'<\/span>');
                    return;
                }
                if($(this).closest('table').first().find('input[name=first_style]').val() == ''){
                    return;
                }
                var o={};
                $(this).closest('table').first().find('.second_style').each(function () {
                    if($(this).val() != ''){
                        if(!(o[$(this).val()])){
                            o[$(this).val()] = true;
                        }else{
                            $parent.append('<span class="formtips onError">'+'输入标签不得重复.'+'<\/span>');
                            $(this).focus();
                            $(this).val('');
                            return false;
                        }
                    }

                });
                //if($(this).val() != '')
                update_style();
            }
           if( $(this).is('.specification') ){
                if( this.value.length > 4 ){
                    $parent.append('<span class="formtips onError">'+'字数不能超过4个字符.'+'<\/span>');
                    $(this).focus();
                }
            }
            if( $(this).is('.specification_Text') || $(this).is('#_productSummary')){
                if( this.value.length > 50 ){
                    $parent.append('<span class="formtips onError">'+'字数不能超过50个字符.'+'<\/span>');
                    $(this).focus();
                }
            }

            //验证price
            var reg = /^\d+(\.\d{0,2})?$/;
            if( $(this).is('input[name=price]') ){
                if( this.value && !reg.test(this.value) ){
                    var errorMsg = '请输入有效的价格，保留两位小数.';
                    $parent.append('<span class="formtips onError">'+errorMsg+'<\/span>');
                    $(this).focus();
                    $(this).val('');
                }
                $(this).parent().prev(':last').children('.checkbox_style_tag').prop('checked', false);
            }
            //验证stockCount
            var pattern = /(^\d+$)/;
            if( $(this).is('input[name=stockCount]') ){
                if( this.value && !pattern.test(this.value) ){
                    var errorMsg = '请输入有效到商品数.';
                    $parent.append('<span class="formtips onError">'+errorMsg+'<\/span>');
                    $(this).focus();
                    $(this).val('');
                }
                $(this).parent().prev(':last').prev(':last').children('.checkbox_style_tag').prop('checked', false);
            }
            // 验证规格
        });
</script>
    <script>

                    function createStyleTag(num){
                        var parent=document.getElementById('id_createTag');
                        var newDiv = document.createElement('table');
                        newDiv.innerHTML = '<tr>\
                                                \<th><input type="text" class="input-medium" name="first_style" id="first_style_'+num+'" placeholder="颜色（最多四个字）">\
                                                <th colspan=3><input type="button" value="删除" class="delete_style_tag"></th>\
                                                </tr>\
                                                <tr>\
                                                    <td>\
                                                        <input type="text" class="second_style" name="second_style_'+num+'"   >\
                                                    </td>\
                                                    <td>\
                                                        <input type="text" class="second_style" name="second_style_'+num+'" >\
                                                    </td>\
                                                    <td>\
                                                        <input type="text" class="second_style" name="second_style_'+num+'">\
                                                    </td>\
                                                    <td>\
                                                        <input type="text" class="second_style" name="second_style_'+num+'" >\
                                                    </td>\
                                                </tr>\
                                                <tr>\
                                                    <td>\
                                                        <input type="text" class="second_style" name="second_style_'+num+'">\
                                                    </td>\
                                                    <td>\
                                                        <input type="text" class="second_style" name="second_style_'+num+'">\
                                                    </td>\
                                                    <td>\
                                                        <input type="text" class="second_style" name="second_style_'+num+'">\
                                                    </td>\
                                                    <td>\
                                                        <input type="text" class="second_style" name="second_style_'+num+'">\
                                                    </td>\
                                                </tr>';
                        if(parent !== null ) {
                            parent.appendChild(newDiv);
                        }
                    }
                    function createStyleInput_bak(first, second, third)
                    {
                        // 清除原来的标签
                        $('#id_StyleTag').empty();
                        $('#product').val('');
                        // 添加新的标签
                        var parent=document.getElementById('id_StyleTag');
                        var newDiv = document.createElement('table');
                        var firstTag = $('input[name=first_style]');
                        // 添加第一行
                        var tmpString = '<tr>';
                        var i, j, k;
                        var tmpProperty = [];
                        for(i=0; i<firstTag.length; i++)
                        if(firstTag[i].value != ''){
                            tmpString += '<td>'+firstTag[i].value+'</td>';
                        }
                        tmpString+= '<td>添加</td><td>价格*</td><td>数量*</td><td>图片（可不填）</td></tr>';


                        if(second.length > 0)
                        {
                            //获得第二级标签的值

                            if(third.length > 0)
                            {
                                //获得第三级标签的值
                                for(i=0; i<first.length; i++)
                                {
                                    for(j=0; j<second.length; j++) {

                                        for (k = 0; k < third.length; k++) {

                                            tmpString +='<tr>';
                                            if(k==0) {
                                                if(j==0) {
                                                    tmpString += '<td rowspan=' + second.length*third.length + '>' + first[i] + '</td>';
                                                }
                                                tmpString +=    '<td rowspan='+third.length+'>' + second[j] + '</td>';
                                            }
                                                tmpString +=    '<td>' + third[k] + '</td>\
                                                                <td><input type="checkbox" class="checkbox_style_tag" name="checkbox_style_tag" value="'+i+"::"+j+"::"+k+'"></td>\
                                                                <td><input type="text" name="price"></td>\
                                                                <td><input type="text" name="stockCount"></td>\
                                                                <td><div class="div_inline"><div class="btn btn-primary btn-upload2" style="float: left;">\
                                                                        <div class="btn-uploadImage2">上传</div><input type="file" class="style_image_file" name="style_image_file"/></div>\
                                                                        <div class="style_image" style="float:left;"></div>\
                                                                        <div style="float:left;"><input class="delete_style_image" type="button" value="删除" style="display: none;"></div>\
                                                                    </div><div style="clear: both"></div></td>\
                                                            </tr>';
                                        }
                                    }
                                }
                            }else {
                                // 只有两级标签
                                for(i=0; i<first.length; i++)
                                {

                                    for(j=0; j<second.length; j++)
                                    {
                                        tmpString +='<tr>';
                                        if(j==0) {
                                            tmpString += '<td rowspan=' + second.length + '>' + first[i] + '</td>';
                                        }
                                            tmpString +=       '<td>'+ second[j]+ '</td>\
                                                                <td><input type="checkbox" class="checkbox_style_tag" name="checkbox_style_tag" value="'+i+"::"+j+'"></td>\
                                                                <td><input type="text" name="price"></td>\
                                                                <td><input type="text" name="stockCount"></td>\
                                                                <td><div class="div_inline"><div class="btn btn-primary btn-upload2" style="float: left;">\
                                                                        <div class="btn-uploadImage2">上传</div><input type="file" class="style_image_file" name="style_image_file"/></div>\
                                                                        <div class="style_image" style="float:left;"></div>\
                                                                        <div style="float:left;"><input class="delete_style_image" type="button" value="删除" style="display: none;"></div>\
                                                                    </div><div style="clear: both"></div></td>\
                                                          </tr>';
                                    }
                                }
                            }
                        }else{
                            // 只有一级标签
                            for(i=0; i<first.length; i++)
                            {
                                tmpString +=    '<tr><td>'+ first[i]+ '</td>\
                                                    <td><input type="checkbox" class="checkbox_style_tag" name="checkbox_style_tag" value="'+i+'"></td>\
                                                    <td><input type="text" name="price"></td>\
                                                    <td><input type="text" name="stockCount"></td>\
                                                    <td><div class="div_inline"><div class="btn btn-primary btn-upload2" style="float: left;">\
                                                            <div class="btn-uploadImage2">上传</div><input type="file" class="style_image_file" name="style_image_file"/></div>\
                                                            <div class="style_image" style="float:left;"></div>\
                                                            <div style="float:left;"><input class="delete_style_image" type="button" value="删除" style="display: none;"></div>\
                                                        </div><div style="clear: both"></div></td>\
                                                </tr>';

                            }

                        }
                        var option = [];
                        for(i=0; i<first.length; i++)
                        {
                            var tmpOption = {
                                "OptionId": i.toString(),
                                "OptionName": first[i]
                            };
                            option.push(tmpOption);
                        }
                        A = {
                            'PropertyId': '0',
                            'PropertyName': firstTag[0].value,
                            'PropertyOption':option
                        };
                        tmpProperty.push(A);
                        if(second.length > 0)
                        {
                            var option = [];
                            for(i=0; i<second.length; i++)
                            {
                                var tmpOption = {
                                    "OptionId": i.toString(),
                                    "OptionName": second[i]
                                };
                                option.push(tmpOption);
                            }
                            A = {
                                'PropertyId': '1',
                                'PropertyName': firstTag[1].value,
                                'PropertyOption':option
                            };
                            tmpProperty.push(A);
                        }
                        if(third.length > 0){
                            var option = [];
                            for(i=0; i<third.length; i++)
                            {
                                var tmpOption = {
                                    "OptionId": i.toString(),
                                    "OptionName": third[i]
                                };
                                option.push(tmpOption);
                            }
                            A = {
                                'PropertyId': '2',
                                'PropertyName': firstTag[2].value,
                                'PropertyOption':option
                            };
                            tmpProperty.push(A);
                        }
                        $('#propertyOption').val(JSON.stringify(tmpProperty).replace(/'/g,'"'));

                        newDiv.innerHTML = tmpString;
                        if(parent !== null )
                            parent.appendChild(newDiv);
                    }
                    function createStyleInput(first, second, third)
                    {
                        // 清除原来的标签
                        $('#id_StyleTag').empty();
                        $('#product').val('');
                        // 添加新的标签
                        var parent=document.getElementById('id_StyleTag');
                        var newDiv = document.createElement('table');
                        var firstTag = $('input[name=first_style]');
                        // 添加第一行
                        var tmpString = '<tr>';
                        var i, j, k;
                        var tmpProperty = [];
                        for(i=0; i<firstTag.length; i++)
                        if(firstTag[i].value != ''){
                            tmpString += '<td>'+firstTag[i].value+'</td>';
                        }
                        tmpString+= '<td>添加</td><td>价格*</td><td>数量*</td><td>图片（可不填）</td></tr>';
                        var secondLength = 0;
                        for(j=0; j<second.length; j++)
                            if(second[j]!='')
                                secondLength++;
                        var thirdLength = 0;
                        for (k = 0; k < third.length; k++)
                            if(third[k]!='')
                                thirdLength++;

                        if(second.length > 0)
                        {
                            //获得第二级标签的值

                            if(third.length > 0)
                            {
                                //获得第三级标签的值
                                for(i=0; i<first.length; i++)
                                if(first[i]!=''){
                                    for(j=0; j<second.length; j++)
                                    if(second[j]!=''){

                                        for (k = 0; k < third.length; k++)
                                        if(third[k]!=''){

                                            tmpString +='<tr>';
                                            if(k==0) {
                                                if(j==0) {
                                                    tmpString += '<td rowspan=' + secondLength*thirdLength + '>' + first[i] + '</td>';
                                                }
                                                tmpString +=    '<td rowspan='+thirdLength+'>' + second[j] + '</td>';
                                            }
                                                tmpString +=    '<td>' + third[k] + '</td>\
                                                                <td><input type="checkbox" class="checkbox_style_tag" name="checkbox_style_tag" value="'+i+"::"+j+"::"+k+'"></td>\
                                                                <td><input type="text" name="price"></td>\
                                                                <td><input type="text" name="stockCount"></td>\
                                                                <td><div class="div_inline"><div class="btn btn-primary btn-upload2" style="float: left;">\
                                                                        <div class="btn-uploadImage2">上传</div><input type="file" class="style_image_file" name="style_image_file"/></div>\
                                                                        <div class="style_image" style="float:left;"></div>\
                                                                        <div style="float:left;"><input class="delete_style_image" type="button" value="删除" style="display: none;"></div>\
                                                                    </div><div style="clear: both"></div></td>\
                                                            </tr>';
                                        }
                                    }
                                }
                            }else {
                                // 只有两级标签
                                for(i=0; i<first.length; i++)
                                if(first[i]!=''){

                                    for(j=0; j<second.length; j++)
                                    if(second[j]!=''){
                                        tmpString +='<tr>';
                                        if(j==0) {
                                            tmpString += '<td rowspan=' + secondLength + '>' + first[i] + '</td>';
                                        }
                                            tmpString +=       '<td>'+ second[j]+ '</td>\
                                                                <td><input type="checkbox" class="checkbox_style_tag" name="checkbox_style_tag" value="'+i+"::"+j+'"></td>\
                                                                <td><input type="text" name="price"></td>\
                                                                <td><input type="text" name="stockCount"></td>\
                                                                <td><div class="div_inline"><div class="btn btn-primary btn-upload2" style="float: left;">\
                                                                        <div class="btn-uploadImage2">上传</div><input type="file" class="style_image_file" name="style_image_file"/></div>\
                                                                        <div class="style_image" style="float:left;"></div>\
                                                                        <div style="float:left;"><input class="delete_style_image" type="button" value="删除" style="display: none;"></div>\
                                                                    </div><div style="clear: both"></div></td>\
                                                          </tr>';
                                    }
                                }
                            }
                        }else{
                            // 只有一级标签
                            for(i=0; i<first.length; i++)
                            if(first[i]!=''){
                                tmpString +=    '<tr><td>'+ first[i]+ '</td>\
                                                    <td><input type="checkbox" class="checkbox_style_tag" name="checkbox_style_tag" value="'+i+'"></td>\
                                                    <td><input type="text" name="price"></td>\
                                                    <td><input type="text" name="stockCount"></td>\
                                                    <td><div class="div_inline"><div class="btn btn-primary btn-upload2" style="float: left;">\
                                                            <div class="btn-uploadImage2">上传</div><input type="file" class="style_image_file" name="style_image_file"/></div>\
                                                            <div class="style_image" style="float:left;"></div>\
                                                            <div style="float:left;"><input class="delete_style_image" type="button" value="删除" style="display: none;"></div>\
                                                        </div><div style="clear: both"></div></td>\
                                                </tr>';

                            }

                        }
                        var option = [];
                        for(i=0; i<first.length; i++)
                        if(first[i]!=''){
                            var tmpOption = {
                                'OptionId': i.toString(),
                                'OptionName': first[i]
                            };
                            option.push(tmpOption);
                        }
                        A = {
                            'PropertyId': '0',
                            'PropertyName': firstTag[0].value,
                            'PropertyOption':option
                        };
                        tmpProperty.push(A);
                        if(second.length > 0)
                        {
                            var option = [];
                            for(i=0; i<second.length; i++)
                            if(second[i]!=''){
                                var tmpOption = {
                                    "OptionId": i.toString(),
                                    "OptionName": second[i]
                                };
                                option.push(tmpOption);
                            }
                            A = {
                                'PropertyId': '1',
                                'PropertyName': firstTag[1].value,
                                'PropertyOption':option
                            };
                            tmpProperty.push(A);
                        }
                        if(third.length > 0){
                            var option = [];
                            for(i=0; i<third.length; i++)
                            if(third[i]!=''){
                                var tmpOption = {
                                    'OptionId': i.toString(),
                                    'OptionName': third[i]
                                };
                                option.push(tmpOption);
                            }
                            A = {
                                'PropertyId': '2',
                                'PropertyName': firstTag[2].value,
                                'PropertyOption':option
                            };
                            tmpProperty.push(A);
                        }
                        $('#propertyOption').val(JSON.stringify(tmpProperty).replace(/'/g,'"'));

                        newDiv.innerHTML = tmpString;
                        if(parent !== null )
                            parent.appendChild(newDiv);
                    }
                    function isRepeat(arr){
                        var hash = {};
                        for(var i in arr) {
                            if(hash[arr[i]])
                                return true;
                            hash[arr[i]] = true;
                        }
                        return false;
                    }
                    function update_style_bak(){
                        //获得第一级标签的值
                        var first = [];
                        var second = [];
                        var third = [];
                        $('input[name=second_style_1]').each(function(){
                        　　 if($(this).val() != "") {
                            　　first.push($(this).val());
                        　　 }
                        });

                        if($('#first_style_2').length > 0 && $('#first_style_2').val() != '' )
                        {
                            //获得第二级标签的值
                            $('input[name=second_style_2]').each(function(){
                            　　 if($(this).val() != "") {
                                　　second.push($(this).val());
                            　　 }
                            });

                            if($('#first_style_3').length > 0 && $('#first_style_3').val() != '' )
                            {
                                //获得第三级标签的值
                                $('input[name=second_style_3]').each(function(){
                                　　 if($(this).val() != "") {
                                    　　third.push($(this).val());
                                　　 }
                                });
                                createStyleInput(first, second, third);
                            }else {
                                // 只有两级标签
                                createStyleInput(first, second, third);
                            }

                        }else{
                            // 只有一级标签
                            if($('#first_style_1').length > 0 && $('#first_style_1').val() != '' ) {
                                createStyleInput(first, second, third);
                            }
                        }
                    }
                    function update_style(){
                        //获得第一级标签的值
                        var first = [];
                        var second = [];
                        var third = [];
                        $('input[name=second_style_1]').each(function(){
                            first.push($(this).val());
                        });

                        if($('#first_style_2').length > 0 && $('#first_style_2').val() != '' )
                        {
                            //获得第二级标签的值
                            $('input[name=second_style_2]').each(function(){
                                second.push($(this).val());
                            });

                            if($('#first_style_3').length > 0 && $('#first_style_3').val() != '' )
                            {
                                //获得第三级标签的值
                                $('input[name=second_style_3]').each(function(){
                                　　 third.push($(this).val());
                                });
                                createStyleInput(first, second, third);
                            }else {
                                // 只有两级标签
                                createStyleInput(first, second, third);
                            }

                        }else{
                            // 只有一级标签
                            if($('#first_style_1').length > 0 && $('#first_style_1').val() != '' ) {
                                createStyleInput(first, second, third);
                            }
                        }
                    }
                    // 当点击添加属性
                    $(document).on('click','#id_add_saleProperty', function () {
                        //if(freshStyleTag()){
                        if(1){
                             if($('#first_style_2').length > 0)
                            {
                                createStyleTag(3);
                                $(this).attr('disabled',true).css('cursor','not-allowed');
                            }else{
                                createStyleTag(2);
                            }
                        }
                    });

                    // 当点击属性删除选项
                    $(document).on('click','.delete_style_tag', function() {
                        $(this).closest('table').remove();
                        $('#product').val('');
                        if($('#id_add_saleProperty').attr('disabled') == 'disabled')
                        {
                            $('#id_add_saleProperty').removeAttr('disabled style');
                        }
                        update_style();
                    });
                    //当在属性选项中点击上传图片按钮给商品
                    $(document).on('change','.style_image_file', function() {
                        var parent = $(this).parent().next();
                        var fileObj = this;

                        //判断多个输入文件的后缀是否是文件

                        var ext = $(this).val().substring($(this).val().lastIndexOf('.') + 1).toLowerCase();

                         // gif在IE浏览器暂时无法显示
                        var $msgParent = $(this).parent().next();
                        $msgParent.find(".formtips").remove();
                         if(ext!=='png' && ext!=='jpg' && ext!=='jpeg'){
                             $msgParent.append('<span class="formtips onError">'+'图片格式不对，请使用png，jpg，或者jpeg.'+'<\/span>');

                             if(parent.children())
                                 parent.children().src='';
                             this.value = '';
                             return;
                        }

                         var size = fileObj.files[0].size / 1024;
                        if (size > 1024){

                            $msgParent.append('<span class="formtips onError">'+'图片大小超过1M.'+'<\/span>');
                            if(parent.children())
                                 parent.children().src='';
                            this.value = '';
                            return;
                        }

                        var image = document.createElement('img');
                        parent.append(image);
                        var file = fileObj.files[0];
                         var isIE = navigator.userAgent.match(/MSIE/)!= null,
                             isIE6 = navigator.userAgent.match(/MSIE 6.0/)!= null;
                         if(isIE) {
                            // IE6浏览器设置img的src为本地路径可以直接显示图片
                              if (isIE6) {
                                  file.select();
                                    var reallocalPath = document.selection.createRange().text;
                                    pic.src = reallocalPath;
                              }else {
                                    var windowURL = window.URL || window.webkitURL;
                                    var dataURL;
                                    if(file) {
                                         dataURL = windowURL.createObjectURL(file);
                                         $(this).parent().next().children('img:first').attr('src',dataURL);
                                    }
                              }
                         }else {
                            var reader = new FileReader();
                            reader.readAsDataURL(file);
                            var image1 = $(this).parent().next().children('img:first');
                            reader.onload = function(e){
                                image1.attr('height', '36');
                                image1.attr('width', '50');
                                image1.attr('src', this.result);
                            }
                         }
                        $(this).parent().next().next().children('input:first').attr('style', 'display: block;');
                        $(this).parent().parent().parent().prev(':last').prev(':last').prev(':last').children('.checkbox_style_tag').prop('checked', false);
                    });
                     $(document).on('click','.delete_style_image', function() {
                        $(this).parent().prev().empty();
                        $(this).attr('style', 'display: none;');
                        $(this).closest('input[type=file]').value = '';
                        $(this).parent().parent().parent().prev(':last').prev(':last').prev(':last').children('.checkbox_style_tag').prop('checked', false);
                    });
                     $(document).on('click','.checkbox_style_tag', function() {
                         var product = [];
                         if ($('#product').val())
                            product = eval('('+$('#product').val()+')');
                         var tmpProduct = {};
                         var key = $(this).val().split('::');

                         var price = $(this).parent().next().children();
                         var stockCount = $(this).parent().next().next().children();
                         var style = [
                             {
                             'PropertyId': '0',
                             'OptionId': key[0].toString(),
                             }
                         ]
                         if(key[1]){
                             style.push({
                                 'PropertyId': '1',
                                 'OptionId': key[1].toString(),
                             });
                         }
                         if(key[2]){
                             style.push({
                                 'PropertyId': '2',
                                 'OptionId': key[2].toString(),
                             });
                         }
                         // checkbox状态更新时，需要重新刷新product的内容
                         if(product){
                             for(var foo in product){
                                if(JSON.stringify(product[foo].style) == JSON.stringify(style)){
                                    product.splice(foo, 1);
                                    break;
                                }
                             }
                         }

                         if($(this).is(':checked'))
                         {
                             var $parent = $(this).parent();
                             $parent.find(".formtips").remove();

                             //验证price
                             if(price.val() == '' ){
                                 var errorMsg = '请输入有效的价格.';
                                 $parent.append('<span class="formtips onError">'+errorMsg+'<\/span>');
                                 return false;
                             }
                             //验证stockCount
                             if( stockCount.val() == '' ){
                                 var errorMsg = '请输入有效到商品数.';
                                 $parent.append('<span class="formtips onError">'+errorMsg+'<\/span>');
                                 return false;
                             }

                             price.attr('style', 'display: block;');
                             stockCount.attr('style', 'display: block;');
                             $(this).parent().next().next().next().children().attr('style', 'display: block;');

                             tmpProduct = {
                                 'style': style,
                                 'price': $(this).parent().next().children('input:first').val(),
                                 'stockCount': $(this).parent().next().next().children('input:first').val(),
                                 'mainImage': $(this).parent().next().next().next().children('div:first').children('div:first').children('div:first').next().val(),
                             }
                             product.push(tmpProduct);

                         }else{
                             price.attr('style', 'display: none;');
                             stockCount.attr('style', 'display: none;');
                             $(this).parent().next().next().next().children().attr('style', 'display: none;');
                         }

                         $('#product').val(JSON.stringify(product).replace(/'/g,'"'));
                    });
                    $(document).on('click', '.delete_image', function () {
                         $(this).prev().empty();
                         $(this).prev().prev().attr('style', 'display:block');
                         $(this).remove();
                     });

                </script>

    <style>
        table{
            border-right:1px solid;
            border-bottom:1px solid;
            border-collapse: collapse;
        }
        table td{
            border-left:1px solid;
            border-top:1px solid;
        }
        .btn-upload {
            position: relative;
            overflow: hidden;
            width: 176px;
            height: 164px;
        }
        .btn-upload input {
            position: absolute;
            top: 7px;
            right: 13px;
            margin: 0;
            padding: 0px 0px 0px 0px;
            font-size: 20px;
            cursor: pointer;
            opacity: 0;
            filter: alpha(opacity=0);
            width: 150px;
            height: 150px;
        }
        .btn-uploadImage{
            text-align: center;
            box-sizing: border-box;
            padding: 0px 0px 0px 0px;
            border-width: 2px;
            border-style: outset;
            border-color: buttonface;
            width: 150px;
            height: 150px;
        }

        .btn-upload2 {
            position: relative;
            overflow: hidden;
            width: 76px;
            height: 44px;
        }
        .btn-upload2 input {
            position: absolute;
            top: 7px;
            right: 13px;
            margin: 0;
            padding: 0px 0px 0px 0px;
            font-size: 20px;
            cursor: pointer;
            opacity: 0;
            filter: alpha(opacity=0);
            width: 50px;
            height: 30px;
        }
        .btn-uploadImage2{
            text-align: center;
            box-sizing: border-box;
            padding: 0px 0px 0px 0px;
            border-width: 2px;
            border-style: outset;
            border-color: buttonface;
            width: 50px;
            height: 30px;
        }
        .delete_style_image{
            margin: 10px;
        }
        .style_image{
            margin: 5px;
        }
        .second {
            background: rgba(85, 85, 85, 0.51);
        }
    </style>
    <div id="">
        <h1>发布商品</h1>
    </div>
    <hr>
    <div>
        {% if content.profile.current_role == 'ProductAdmin' %}
        <form enctype="multipart/form-data" method="POST" action="{% url 'Product:CreateProductGroup' %}?timestamp={{ content.time }}"  id="form1" onsubmit="return check();">
        {% endif %}
        {% if content.profile.current_role == 'Shop' %}
        <form enctype="multipart/form-data" method="POST" action="{% url 'TmpProductGroup:CreateProductGroup' %}" id="form1" onsubmit="return check();">
        {% endif %}

            {% csrf_token %}
            <input type="hidden" name="prevToken" value="{{ content.prevToken }}">
            <input type="hidden" name="_shopObjectId" value="{{ content.data.shopObjectId }}">
            <input type="hidden" name="propertyOption" id="propertyOption">
            <input type="hidden" id="product" name="product" >
            <div>
                <h2 class="second">库存分类</h2>
                <hr>
                <div id="id_storeCategory_parent">

                </div>
                <table>
                    <td>
                        <div style="margin: 10px; padding: 10px;">
                            {% for firstlevel in content.data.storeCategory %}
                                <label class="radio">
                                {% if forloop.first %}
                                  <input type="radio" onclick="clickFirstLevel1({{ forloop.counter }})" name="_checkbox_product_name1" value="{{ firstlevel.name }}" checked>
                                  {{ firstlevel.name }}
                                {% else %}
                                    <input type="radio" onclick="clickFirstLevel1({{ forloop.counter }})" name="_checkbox_product_name1" value="{{ firstlevel.name }}">
                                  {{ firstlevel.name }}
                                {% endif %}
                                </label>
                            {% endfor %}
                        </div>
                    </td>
                    <td>
                        <div style="margin: 10px; padding: 10px;">
                            {% for firstlevel in content.data.storeCategory %}
                                {% if forloop.first %}
                                    <div id="_secondLevel{{ forloop.counter }}" style="display: block;" name="_firstShowOne">
                                    {% else %}
                                    <div id="_secondLevel{{ forloop.counter }}" style="display: none;" name="_firstShowOne" >
                                {% endif %}

                                    {% for secondlevel in firstlevel.value %}
                                        <label class="radio">
                                        {% if forloop.parentloop.first and  forloop.first %}
                                            <input type="radio" id="_checkbox_product_name2{{ forloop.parentloop.counter }}{{ forloop.counter }}"
                                                   onclick="clickSecondLevel1({{ forloop.parentloop.counter }},{{ forloop.counter }})" name="_checkbox_product_name2" value="{{ secondlevel.name }}" checked>
                                        {% else %}
                                            <input type="radio" id="_checkbox_product_name2{{ forloop.parentloop.counter }}{{ forloop.counter }}"
                                                   onclick="clickSecondLevel1({{ forloop.parentloop.counter }},{{ forloop.counter }})" name="_checkbox_product_name2" value="{{ secondlevel.name }}">
                                        {% endif %}
                                        {{ secondlevel.name }}
                                        </label>
                                    {% endfor %}
                                {% if forloop.first %}
                                    </div>
                                    {% else %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </td>
                    <td>
                        <div style="margin: 10px; padding: 10px;">
                            {% for firstlevel in content.data.storeCategory %}
                                    {% for secondlevel in firstlevel.value %}
                                    <div>
                                        {% if forloop.first and forloop.parentloop.first %}
                                            <div id="_firstShowTwo{{ forloop.parentloop.counter }}{{ forloop.counter }}" style="display: block;" name="_firstShowTwo" >
                                        {% else %}
                                            <div id="_firstShowTwo{{ forloop.parentloop.counter }}{{ forloop.counter }}" style="display: none;" name="_firstShowTwo" >
                                        {% endif %}

                                        {% for thirdlevel in secondlevel.value %}
                                        <label class="radio">
                                        {% if forloop.first and forloop.parentloop.first and forloop.parentloop.parentloop.first %}
                                            <input type="radio" name="storeCategory" id="_checkbox_product_name3{{ forloop.parentloop.parentloop.counter }}{{ forloop.parentloop.counter }}{{ forloop.counter }}"
                                                   value="{{ thirdlevel.objectId }}" checked>
                                        {% else %}
                                            <input type="radio" name="storeCategory" id="_checkbox_product_name3{{ forloop.parentloop.parentloop.counter }}{{ forloop.parentloop.counter }}{{ forloop.counter }}"
                                                   value="{{ thirdlevel.objectId }}">
                                        {% endif %}
                                            {{ thirdlevel.name }}
                                        </label>
                                        {% endfor %}
                                        {% if forloop.first and forloop.parentloop.first %}
                                            </div>
                                            {% else %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                            {% endfor %}
                        </div>
                    </td>
                </table>
            </div>

            <p></p>
            <div style="margin-top: 40px">
                <h2 class="second">销售类别</h2>
                <hr>
                <div id="_saleContainer">
                <table>
                    <td>
                        <div style="margin: 10px; padding: 10px; width: 200px;">
                        {% for firstlevel in content.data.saleCategory %}
                            <label class="radio">
                                {% if forloop.first == forloop.counter %}
                                    <input type="radio" id="_checkbox_sale_name1{{ forloop.counter }}" onclick="clickFirstLevel2({{ forloop.counter }})" name="_checkbox_sale_name1" value="{{ firstlevel.name }}" checked>{{ firstlevel.name }}
                                {% else %}
                                    <input type="radio" id="_checkbox_sale_name1{{ forloop.counter }}" onclick="clickFirstLevel2({{ forloop.counter }})" name="_checkbox_sale_name1" value="{{ firstlevel.name }}">{{ firstlevel.name }}
                                {% endif %}
                            </label>
                        {% endfor %}
                        </div>
                    </td>
                    <td>
                       <div style="margin: 10px; padding: 10px;width: 200px; ">
                        {% for firstlevel in content.data.saleCategory %}
                            {% if forloop.first %}
                                <div id="_secondLevel2{{ forloop.counter }}" name="_secondShow" style="display: block">
                            {% else %}
                                <div id="_secondLevel2{{ forloop.counter }}" name="_secondShow" style="display: none;">
                            {% endif %}
                                {% for secondlevel in firstlevel.value %}
                                    <label class="radio">
                                    {% if forloop.parentloop.first == forloop.parentloop.counter and forloop.first == forloop.counter %}
                                       <input type="radio" name="saleCategory" id="_checkbox_sale_name2{{ forloop.parentloop.counter }}{{ forloop.counter }}"
                                              value="{{ secondlevel.objectId }}" checked>{{ secondlevel.name }}
                                    {% else %}
                                       <input type="radio" name="saleCategory" id="_checkbox_sale_name2{{ forloop.parentloop.counter }}{{ forloop.counter }}"
                                              value="{{ secondlevel.objectId }}" >{{ secondlevel.name }}
                                    {% endif %}
                                    </label>
                                {% endfor %}
                            {% if forloop.first %}
                                </div>
                            {% else %}
                                </div>
                            {% endif %}
                        {% endfor %}
                        </div>
                    </td>
                </table>
                    </div>
            </div>
            <div style="margin-top: 40px">
                <h2 class="second">商品名</h2>
               <hr>
                <div>
                    <input placeholder="Input value" type="text" class="input-medium" id="_productName" name="name" value="test" required>
                </div>
            </div>
            <div style="margin-top: 40px">
                <h2 class="second">商品简介</h2>
                <hr>
                <div>
                    <input placeholder="Input value" type="text" class="input-medium" id="_productSummary" name="briefDescription" value="这个商品很棒" required>
                </div>
            </div>
            <p></p>
            <div style="margin-top: 40px">
                <h2 class="second">商品发货地</h2>
                <hr>
                <div data-toggle="distpicker" id="distpicker">
                <div class="form-group">
                    <label class="sr-only" for="province1">省</label>
                    <select class="form-control" id="province1" name="id_province" ></select>
                    <div style="clear: both;"></div>
                </div>
                <div class="form-group">
                    <label class="sr-only" for="city1">市</label>
                    <select class="form-control" id="city1" name="id_city"></select>
                    <div style="clear: both;"></div>
                </div>
                <div class="form-group">
                    <label class="sr-only" for="district1">区</label>
                    <select class="form-control" id="district1" name="id_district" ></select>
                    <div style="clear: both;"></div>
                </div>
            </div>

            </div>
            <p></p>

            <div style="margin-top: 40px">
                <div>上传所有图片（主图必须有，最多五张，图片有顺序）</div>
                <hr>
                <div class="row">
                    {% for foo in content.range %}
                        {% if  foo < 6 %}
                            <div style="margin: 20px;" class="span2">
                                <div id="_first_{{ foo }}" class="div_inline ">
                                    <div class="btn btn-primary btn-upload" id="_idHidden_{{ foo }}">
                                        <div class="btn-uploadImage">上传</div>
                                        {% if foo == 1 %}
                                        <input id="_imageFile_{{ foo }}" type="file" name="mainImage"  onchange="loadImage({{ foo }});" required/>
                                        {% else %}
                                        <input id="_imageFile_{{ foo }}" type="file" name="imageList"  onchange="loadImage({{ foo }});" />
                                        {% endif %}
                                    </div>
                                    <div id="_image_{{ foo }}">

                                    </div>
                                </div>
                            </div>

                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <div style="margin-top: 40px">
                <h2 class="second">属性选项(至少一组，最多三组，所有组合不得超过100个)</h2>
                <hr>

                <div>
                    <div id="id_createTag">
                        <table>
                            <tr>
                                <th>
                                <input type="text" class="input-medium" name="first_style" id="first_style_1" placeholder="颜色（最多四个字）">
                                </th>
                                <th colspan="3">
                                </th>
                            </tr>
                            <tr>
                                <td>
                                    <input type="text" class="second_style" name="second_style_1" id="" >
                                </td>
                                <td>
                                    <input type="text" class="second_style" name="second_style_1" id="">
                                </td>
                                <td>
                                    <input type="text" class="second_style" name="second_style_1" id="" >
                                </td>
                                <td>
                                    <input type="text" class="second_style" name="second_style_1" id="" >
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <input type="text" class="second_style" name="second_style_1" id="">
                                </td>
                                <td>
                                    <input type="text" class="second_style" name="second_style_1" >
                                </td>
                                <td>
                                    <input type="text" class="second_style" name="second_style_1" >
                                </td>
                                <td>
                                    <input type="text" class="second_style" name="second_style_1" >
                                </td>
                            </tr>
                        </table>


                    </div>
                    <div>
                        <input class="btn" type="button" id="id_add_saleProperty" value="增加销售属性">
                    </div>

                    <div id="id_StyleTag">
                            <td>

                            </td>
                    </div>
                </div>
                <div>

                </div>
            </div>
            <p></p>
            <div>
                <h2 class="second">商品服务</h2>
                <hr>
                <ul>
                    {% for foo in content.data.productService %}
                        <li>
                            <input type="checkbox" id="_productService" name="productService" value="{{ foo.objectId }}" checked>{{ foo.name }}
                        </li>
                    {% endfor %}

                </ul>
            </div>

            <div style="margin-top: 40px">


                <h2 class="second">商品规格</h2>
                <hr>
                <table>
                    <tr><h3>商品规格（最多15条）</h3></tr>
                    <tr>
                        <td>
                            <input type="text" class="specification" name="specification_1" style="width: 200px;" placeholder="规格（必填项，最多四个字）" style="width: 200px;" required>
                        </td>
                        <td>
                            ：
                        </td>
                        <td>
                            <input type="text" class="specification_Text" name="specification_Text_1" style="width: 400px;" placeholder="规格介绍（必填项，50个字）" style="width: 400px;" required>
                        </td>
                    </tr>
                    {% for foo in content.range %}
                        {% if foo > 1 and foo < 16 %}
                            <tr>
                                <td>
                                    <input type="text" class="specification" name="specification_{{ foo }}" value="" placeholder="规格（选填，最多四个字）" style="width: 200px;" >
                                </td>
                                <td>
                                    ：
                                </td>
                                <td>
                                    <input type="text" class="specification_Text" name="specification_Text_{{ foo }}" value="" placeholder="规格介绍（选填，50个字）" style="width: 400px;">
                                </td>
                            </tr>
                        {% endif %}
                    {% endfor %}

                </table>
            </div>
            <div style="margin-top: 40px">

                <h2 class="second">编辑商品详情</h2>
                <hr>
                <div class="row">
                    {% for foo in content.range %}
                        {% if  foo < 11 and foo > 5 %}
                            <div style="margin: 20px;" class="span2">
                                <div id="_first_{{ foo }}" class="div_inline ">
                                    <div class="btn btn-primary btn-upload" id="_idHidden_{{ foo }}">
                                        <div class="btn-uploadImage">上传</div>

                                        <input id="_imageFile_{{ foo }}" type="file" name="detailDescription"  onchange="loadImage({{ foo }});" {% if foo == 6 %}required{% endif %}/>
                                    </div>
                                    <div id="_image_{{ foo }}">

                                    </div>
                                </div>
                            </div>

                        {% endif %}
                    {% endfor %}
                </div>
                <div class="row">
                    {% for foo in content.range %}
                        {% if  foo < 16 and foo > 10 %}
                            <div style="margin: 20px;" class="span2">
                                <div id="_first_{{ foo }}" class="div_inline ">
                                    <div class="btn btn-primary btn-upload" id="_idHidden_{{ foo }}">
                                        <div class="btn-uploadImage">上传</div>
                                        <input id="_imageFile_{{ foo }}" type="file" name="detailDescription"  onchange="loadImage({{ foo }});" />
                                    </div>
                                    <div id="_image_{{ foo }}">

                                    </div>
                                </div>
                            </div>

                        {% endif %}
                    {% endfor %}
                </div>
               <input id="id_detailDescription" name="detailDescription" type="hidden">
            </div>
            <p></p>
            <div style="margin-top: 40px">
                <hr>
                {% if content.profile.current_role == 'ProductAdmin' %}
                 <div>
                    <input class="btn btn-default" type="submit" name="shelf_on" id="sub1"  value="上架">
                    <input class="btn btn-default" type="submit" name="shelf_off" id="sub1" value="入库">
                </div>
                {% endif %}
                {% if content.profile.current_role == 'Shop' %}
                    <div>
                    <input class="btn btn-default" type="submit" name="audit" id="sub1" value="提交审核">
                </div>
                {% endif %}

            </div>

        </form>
    </div>
    <hr>
    <div>
        {% if content.profile.current_role == 'ProductAdmin' %}
            <a onclick="" href="{% url 'Shop:AllShop' %}?objectId={{ content.data.shopObjectId  }}&&timestamp={{ content.time }}">返回店铺</a>
        {% endif %}
        {% if content.profile.current_role == 'Shop' %}
            <a onclick="" href="{% url 'Shop:AllShop' %}?objectId={{ content.data.shopObjectId  }}&&timestamp={{ content.time }}">返回店铺</a>
        {% endif %}

    </div>
{% endblock %}